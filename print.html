<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>ROS Project 2024</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">Introduction</a></li><li class="chapter-item expanded "><a href="download-xilinx.html"><strong aria-hidden="true">1.</strong> Download Xlinix</a></li><li class="chapter-item expanded "><a href="bdf.html"><strong aria-hidden="true">2.</strong> BDF</a></li><li class="chapter-item expanded "><a href="install-ros.html"><strong aria-hidden="true">3.</strong> Install ROS</a></li><li class="chapter-item expanded "><a href="helloworld/index.html"><strong aria-hidden="true">4.</strong> Hello World</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="helloworld/hello-microblaze.html"><strong aria-hidden="true">4.1.</strong> Hello Microblaze</a></li><li class="chapter-item expanded "><a href="helloworld/hello-ros.html"><strong aria-hidden="true">4.2.</strong> Hello ROS</a></li></ol></li><li class="chapter-item expanded "><a href="add-uart.html"><strong aria-hidden="true">5.</strong> Add UART</a></li><li class="chapter-item expanded "><a href="ros-proj-in-vitis.html"><strong aria-hidden="true">6.</strong> ROS project in vitis</a></li><li class="chapter-item expanded "><a href="gpio-n-interrupts.html"><strong aria-hidden="true">7.</strong> GPIO & Interrupts</a></li><li class="chapter-item expanded "><a href="code-over-view.html"><strong aria-hidden="true">8.</strong> Code Over View</a></li><li class="chapter-item expanded "><a href="running.html"><strong aria-hidden="true">9.</strong> Running everthing</a></li><li class="chapter-item expanded "><a href="img-pipline.html"><strong aria-hidden="true">10.</strong> Image Pipline</a></li><li class="chapter-item expanded "><a href="file.html"><strong aria-hidden="true">11.</strong> Files</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">ROS Project 2024</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<h2 id="background"><a class="header" href="#background">Background:</a></h2>
<p>The proliferation of robotics in the domain of edge devices necessitates efficient communication among these devices. To address this need, µROS was developed as a user-friendly tool for managing communications in robotics.</p>
<h2 id="purpose"><a class="header" href="#purpose">Purpose:</a></h2>
<p>Efficiency in computing substrates is critical to the success of robotic applications. While various platforms exist, FPGA has emerged as a promising substrate for robotic applications. However, µROS is not compatible well with FPGA and our work presents an implementation of µROS in MicroBlaze, an FPGA typed microprocessor.</p>
<h2 id="methods"><a class="header" href="#methods">Methods:</a></h2>
<p>First, we would develop the basic generic µROS infrastructure to MicroBlaze FPGA in an intelligent and efficient manner. We then improved the current MicroBlaze support for µROS by using more advanced data transfer methods like Interrupts.</p>
<h2 id="results"><a class="header" href="#results">Results:</a></h2>
<p>Development of an infrastructure that combines the capabilities of MicroBlaze with the functionality of µROS and has proven by communication demos.</p>
<h2 id="conclusion"><a class="header" href="#conclusion">Conclusion:</a></h2>
<p>Our developed infrastructure demonstrates the feasibility of having µROS on an FPGA processor and paving the way for further improvement in the future.</p>
<h2 id="setup"><a class="header" href="#setup">Setup</a></h2>
<ul>
<li>Ubuntu 22.04.4 LTS</li>
<li>Xilinx Ultra96 Zynq UltraSCALE+  (NOT V2 !!)</li>
<li>Avnet JTAG</li>
<li>microUSB to USB-A</li>
<li>Power Brick</li>
</ul>
<h2 id="todo"><a class="header" href="#todo">TODO:</a></h2>
<ul>
<li><input disabled="" type="checkbox" checked=""/>
Hello World -&gt; Hello ROS</li>
<li><input disabled="" type="checkbox"/>
Add files to md book vivido project and XSA file (check we can send vivato project proparly)
<ul>
<li><input disabled="" type="checkbox"/>
Final Project (latest code change vitis)</li>
<li><input disabled="" type="checkbox" checked=""/>
XSA (w and w/out GPIO)</li>
<li><input disabled="" type="checkbox" checked=""/>
uROS ws (the whole file)</li>
<li><input disabled="" type="checkbox" checked=""/>
BDF master</li>
</ul>
</li>
<li><input disabled="" type="checkbox" checked=""/>
Review files</li>
<li><input disabled="" type="checkbox" checked=""/>
Add chapters from Michael? (How to download vitas and so on….)</li>
<li><input disabled="" type="checkbox" checked=""/>
Update introduction (using linux versions and so on)</li>
<li><input disabled="" type="checkbox"/>
Chapter with finished code (ROS controller by GPIO)</li>
<li><input disabled="" type="checkbox" checked=""/>
Link to XSA file inside create Vitis project</li>
<li><input disabled="" type="checkbox"/>
Publish book</li>
<li><input disabled="" type="checkbox"/>
Add Code over view
<ul>
<li><input disabled="" type="checkbox"/>
Stack size</li>
</ul>
</li>
<li><input disabled="" type="checkbox"/>
How to run. (finish)
<ul>
<li><input disabled="" type="checkbox"/>
Add chapter of run ros on computer</li>
<li>first open ROS in terminal, then build project then run project</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="download-software"><a class="header" href="#download-software">Download Software</a></h1>
<h2 id="basic-information"><a class="header" href="#basic-information">Basic Information</a></h2>
<p>In our project we will use the software called Vitis unified software platform from Xilinx
It includes 2 main softwares</p>
<ol>
<li>Vitis – IDE for programing ther FPGA and running the code</li>
<li>Vivado – for creating the hardware for the FPGA</li>
</ol>
<p>This is a tool  that combines all aspects of Xilinx® software development into one unified environment. The Vitis software platform supports both the Vitis embedded software development flow, for Xilinx Software Development Kit (SDK) users looking to move into the next generation technology, and the Vitis application acceleration development flow, for software developers looking to use the latest in Xilinx FPGA-based software acceleration.</p>
<p>The Vitis™ software platform consists of an integrated design environment (IDE) for interactive project development, and command-line tools for scripted or manual application development. The Vitis software platform also includes the Vivado® Design Suite for implementing the kernel on the target device, and for developing custom hardware platforms.</p>
<p><a href="files/Hello_World/Hello_Microblaze/design_Ultra96_MicroBlaze_wrapper.zip">xsa file</a></p>
<h2 id="download-files"><a class="header" href="#download-files">Download files</a></h2>
<ul>
<li><a href="https://www.xilinx.com/support/download/index.html/content/xilinx/en/downloadNav/vitis.html">Downloads</a></li>
</ul>
<p>Go to Vitis (SW Developer) and download the installer for your operating system</p>
<p>We worked with version 2022.2: (Linux and windows versions)</p>
<h2 id="installation-tutorial-windows"><a class="header" href="#installation-tutorial-windows">Installation Tutorial (Windows)</a></h2>
<ol>
<li>open .EXE file</li>
<li>click next<br />
<img src="images/Dowload_Xilinx/download_software1.png" alt="pic" /></li>
<li>Login to your account of xilinx (if you don’t have, register one)<br />
<img src="images/Dowload_Xilinx/download_software2.png" alt="pic" /></li>
<li>Choose Vitis<br />
<img src="images/Dowload_Xilinx/download_software3.png" alt="pic" /></li>
<li>In the next screen, we need to choose the products we want to install. For the full installation you will need 245 GB disk space<br />
<img src="images/Dowload_Xilinx/download_software4.png" alt="pic" />
If you don’t have the space requirement, the only products we need to choose for our project are:<br />
<img src="images/Dowload_Xilinx/download_software5.png" alt="pic" /></li>
</ol>
<p>For the SoCs, you can also remove Zynq-7000 and Zynq UltraScale + RFSoC because our board is Zynq UltraScale + MPSoC. The vitis Model composer is also optional so if you still don’t have enough disk space, buy a new one</p>
<ol start="7">
<li>Click i agree to all the license agreements and then install regualry\</li>
</ol>
<h2 id="installation-tutorial-linux"><a class="header" href="#installation-tutorial-linux">Installation Tutorial (Linux)</a></h2>
<p>Download the installer from the download page only this time choose the one for linux</p>
<ol>
<li>
<p>Right click on the bin file → properties → Permissions → Check the Execute option<br />
<img src="images/Dowload_Xilinx/download_software6.png" alt="pic" /></p>
</li>
<li>
<p>Open Terminal inside the folder contains the bin file (Or open terminal then cd to the path contains the bin file)</p>
</li>
<li>
<p>Run the following commands:  (To get the file name easy)</p>
</li>
</ol>
<pre><code class="language-bash">	ls -ltr
</code></pre>
<ol start="4">
<li>
<p>Then type the command: sudo ./<em>File_Name</em>
For example:<br />
<img src="images/Dowload_Xilinx/download_software7.png" alt="pic" /></p>
</li>
<li>
<p>then type your password and then it should open the xilinx installer<br />
<img src="images/Dowload_Xilinx/download_software8.png" alt="pic" /></p>
</li>
<li>
<p>Then its the same like for the windows.</p>
</li>
<li>
<p>Open terminal and type in the command (check the vitas version):</p>
</li>
</ol>
<pre><code class="language-bash">	source &lt;Vitis_install_path&gt;/Vitis/2022.2/settings64.sh
</code></pre>
<p>In my case the path was:</p>
<pre><code class="language-bash">/tools/Xilinx/Vitis/2022.2/settings64.sh
</code></pre>
<p>Then to lunch the vitis ide type in</p>
<pre><code class="language-bash">vitis
</code></pre>
<p>(For the other apps like vivado, vitis_hls do the same just source to the right path)</p>
<h2 id="installing-cable-drivers-only-for-linux"><a class="header" href="#installing-cable-drivers-only-for-linux">Installing Cable Drivers (Only for linux)</a></h2>
<p>During the installtion we can’t select the option to install the cable drivers and it needs to be done manually:</p>
<pre><code class="language-bash">cd &lt;install drivers path&gt;
</code></pre>
<p>in  my case it was</p>
<pre><code class="language-bash">&lt;Vitis Install&gt;/data/xicom/cable_drivers/lin64/install_script/install_drivers/
</code></pre>
<p><img src="images/Dowload_Xilinx/download_softwar9.png" alt="pic" /></p>
<p>then run the command:</p>
<pre><code class="language-bash">sudo ./install_drivers
</code></pre>
<p><img src="images/Dowload_Xilinx/download_software10.png" alt="pic" /></p>
<h3 id="possible-error"><a class="header" href="#possible-error">Possible Error</a></h3>
<p>If the installer hang on the "Generating installed device list" step
Open terminal and type in the command:</p>
<pre><code class="language-bash">	sudo apt-get install libtinfo5
</code></pre>
<p>as documented <a href="https://support.xilinx.com/s/article/76616?language=en_US">here</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="bdf-files"><a class="header" href="#bdf-files">BDF Files</a></h1>
<p>Your next step will be to add the needed Avnet Board Definition Files to your Vivado file path.</p>
<h2 id="download"><a class="header" href="#download">Download</a></h2>
<p>The source is <a href="https://github.com/Avnet/bdf">https://github.com/Avnet/bdf</a>
click on code and and then click download zip</p>
<p><img src="images/BDF/BDF_1.jpeg" alt="pic" /></p>
<p>for Ultra96 (v1) board you can download directly from here <br />
<a href="files/Vivado/ultra96v1.zip">V1 Board</a><br />
<a href="files/Vivado/ultra96v2.zip">V2 Board</a></p>
<h2 id="on-your-computer"><a class="header" href="#on-your-computer">On Your Computer</a></h2>
<p>After you extract the ZIP folder, you will need to copy the desired BDF  folders dicitly to the following directory</p>
<pre><code class="language-bash">&lt;your_path&gt;\Xilinx\Vivado\&lt;version&gt;\data\boards\board_files
</code></pre>
<p>where version is 2022.2 for example
Pay attention, as some of the borads sit under the deprecated folder</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="install-ros-and-create-micro-ros-firmware-inside-ubuntu-2204"><a class="header" href="#install-ros-and-create-micro-ros-firmware-inside-ubuntu-2204">Install ROS and Create micro-ROS Firmware inside Ubuntu 22.04</a></h1>
<h2 id="install-ros-2"><a class="header" href="#install-ros-2">Install ROS 2</a></h2>
<p>Use the following link to download and set up ROS 2:<br />
<a href="https://docs.ros.org/en/humble/Installation/Ubuntu-Install-Debians.html">ROS 2 Installation Instructions</a></p>
<p>Follow these steps inside the page:</p>
<ol>
<li>
<p>Set locale (you can use the following to check if OS supports UTF-8 in your terminal)</p>
<pre><code class="language-bash">echo -e '\xe2\x82\xac'
</code></pre>
<p>if UTF-8 is supported it should print out euro symbol</p>
<pre><code class="language-bash">€
</code></pre>
</li>
<li>
<p>Setup Sources</p>
</li>
<li>
<p>Install ROS 2 packages</p>
</li>
<li>
<p>Environment setup</p>
</li>
</ol>
<h2 id="install-micro-ros-build-system"><a class="header" href="#install-micro-ros-build-system">Install micro-ROS Build System</a></h2>
<p>Now we need to create the micro-ROS build system.
The following steps were taken from (there is no need to use the link):<br />
<a href="https://micro.ros.org/docs/tutorials/core/first_application_rtos/freertos/">micro-ROS Build System Instructions</a></p>
<p>Make sure to replace <code>ROS_DISTRO</code> with the desired ROS version for us its "humble".</p>
<h3 id="source-the-ros-2-installation"><a class="header" href="#source-the-ros-2-installation">Source the ROS 2 Installation</a></h3>
<pre><code class="language-bash">source /opt/ros/$ROS_DISTRO/setup.bash
</code></pre>
<h3 id="create-a-workspace-and-download-the-micro-ros-tools"><a class="header" href="#create-a-workspace-and-download-the-micro-ros-tools">Create a Workspace and Download the micro-ROS Tools</a></h3>
<pre><code class="language-bash">mkdir microros_ws
cd microros_ws
git clone -b $ROS_DISTRO https://github.com/micro-ROS/micro_ros_setup.git src/micro_ros_setup
</code></pre>
<h3 id="update-dependencies-using-rosdep"><a class="header" href="#update-dependencies-using-rosdep">Update Dependencies Using rosdep</a></h3>
<pre><code class="language-bash">sudo apt update &amp;&amp; rosdep update
rosdep install --from-paths src --ignore-src -y
</code></pre>
<h3 id="install-pip"><a class="header" href="#install-pip">Install pip</a></h3>
<pre><code class="language-bash">sudo apt-get install python3-pip
</code></pre>
<h3 id="build-micro-ros-tools-and-source-them"><a class="header" href="#build-micro-ros-tools-and-source-them">Build micro-ROS Tools and Source Them</a></h3>
<pre><code class="language-bash">colcon build
source install/local_setup.bash
</code></pre>
<h2 id="create-firmware-for-the-microblaze"><a class="header" href="#create-firmware-for-the-microblaze">Create Firmware for the Microblaze</a></h2>
<p>Now we need to create the micro-ROS libraries.
The following steps were taken from (there is no need to use the link):<br />
<a href="https://micro.ros.org/docs/tutorials/advanced/create_custom_static_library/">Creating Custom Static Library Instructions</a></p>
<h3 id="run-the-following-command-and-create-the-firmware-directory"><a class="header" href="#run-the-following-command-and-create-the-firmware-directory">Run the Following Command and Create the Firmware Directory</a></h3>
<pre><code class="language-bash">ros2 run micro_ros_setup create_firmware_ws.sh generate_lib
</code></pre>
<h3 id="create-colcon-and-toolchain-files"><a class="header" href="#create-colcon-and-toolchain-files">Create colcon and Toolchain Files</a></h3>
<pre><code class="language-bash">touch my_custom_toolchain.cmake
touch my_custom_colcon.meta
</code></pre>
<p>Copy and paste from the supplied files into the created files.<br />
<a href="files/uROS/my_custom_colcon.meta">my_custom_colcon.meta</a><br />
<a href="files/uROS/my_custom_toolchain.cmake">my_custom_toolchain.cmake</a></p>
<p>Inside the Cmake file, change the following lines according to the correct Xilinx version.</p>
<pre><code class="language-bash"># SET HERE THE PATH TO YOUR C99 AND C++ COMPILERS
set(CMAKE_C_COMPILER /tools/Xilinx/Vitis/2022.2/gnu/microblaze/lin/bin/mb-gcc)
set(CMAKE_CXX_COMPILER /tools/Xilinx/Vitis/2022.2/gnu/microblaze/lin/bin/mb-g++)
</code></pre>
<p>Inside the colcon file, you can change the properties of the micro-ros (such as number of nodes)</p>
<pre><code class="language-bash">        "rmw_microxrcedds": {
            "cmake-args": [
                "-DRMW_UXRCE_MAX_NODES=1",
                "-DRMW_UXRCE_MAX_PUBLISHERS=5",
                "-DRMW_UXRCE_MAX_SUBSCRIPTIONS=5",
                "-DRMW_UXRCE_MAX_SERVICES=1",
                "-DRMW_UXRCE_MAX_CLIENTS=1",
                "-DRMW_UXRCE_MAX_HISTORY=4",
                "-DRMW_UXRCE_TRANSPORT=custom"
            ]
        },
</code></pre>
<h3 id="create-firmware--create-the-build-directory-and-a-file"><a class="header" href="#create-firmware--create-the-build-directory-and-a-file">Create Firmware – Create the Build Directory and .a File</a></h3>
<pre><code class="language-bash">ros2 run micro_ros_setup build_firmware.sh $(pwd)/my_custom_toolchain.cmake $(pwd)/my_custom_colcon.meta
</code></pre>
<h3 id="files"><a class="header" href="#files">Files</a></h3>
<p>We add are workstation files for your convinace.
The filnes include all you need to start working build and everything including an image pipline.<br />
<a href="files/ROS/ros2_ws.zip">ros2_ws</a><br />
<a href="files/uROS/microros_ws.zip">microros_ws</a></p>
<h3 id="current-problems"><a class="header" href="#current-problems">Current Problems</a></h3>
<p><strong>Directory Structure</strong>:<br />
In one of the updates of ROS, the directory structure of the files changed.<br />
From:</p>
<pre><code class="language-cpp">#include &lt;rcl/rcl.h&gt;
</code></pre>
<p>To:</p>
<pre><code class="language-cpp">#include &lt;rcl/rcl/rcl.h&gt;
</code></pre>
<p>The problem is that the <code>#include</code> lines inside the files are not compatible with the new version.<br />
The current solution is to build the project and then to add links to each subdirectory needed so the compiler will see these directories as written in the includes (for example – add link to the first <code>rcl</code> directory).<br />
Wanted solution – probably a CMake file problem.
Current Solution: during the build of the code inside vitis, we will create links for the sub files (explained in <a href="ros-proj-in-vitis.html">ROS project in Vitis</a>)</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="hello-world"><a class="header" href="#hello-world">Hello World</a></h1>
<p>This examples will make sure you have every thing setup proparly to start working.
Make sure to run Xilinx Hello word in a new project, then you can change it to Hello ROS.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="hello-microblaze"><a class="header" href="#hello-microblaze">Hello Microblaze</a></h1>
<p>In this tutorial we will explain step-by-step how to create basic freeRTOS application running on the MicroBlaze that transmit few messages.</p>
<p>Below is the xsa design of ultra96 with microblaze to work with freeRTOS:</p>
<h3 id="download-the-xsa-file"><a class="header" href="#download-the-xsa-file">Download The XSA File</a></h3>
<p>You will need the design in XSA format to open the project.
Download the file and put it in the desired folder</p>
<p>file 1 (ddr, without gpio)</p>
<h3 id="open-new-project"><a class="header" href="#open-new-project">Open New Project</a></h3>
<ol>
<li>
<p>go to File - New - Application Projetc
<img src="helloworld/../images/Hello_World/Hello_Microblaze/pic1.jpg" alt="HB1" /></p>
</li>
<li>
<p>click next
<img src="helloworld/../images/Hello_World/Hello_Microblaze/pic2.png" alt="HB2" /></p>
</li>
<li>
<p>Go to the tab “Create a new platform from hardware (XSA)
<img src="helloworld/../images/Hello_World/Hello_Microblaze/pic3.png" alt="HB3" /></p>
</li>
<li>
<p>Click browse and go to the the XSA file and choose it
<img src="helloworld/../images/Hello_World/Hello_Microblaze/pic4.png" alt="HB4" /></p>
</li>
<li>
<p>then click next. create a new system project and choose from the target processor the microblaze_0
<img src="helloworld/../images/Hello_World/Hello_Microblaze/pic5.png" alt="HB5" /></p>
</li>
<li>
<p>Under operating system, choose freertos10_xilinx
<img src="helloworld/../images/Hello_World/Hello_Microblaze/pic6.png" alt="HB6" /></p>
</li>
<li>
<p>Choose a code template (You can choose FreeRTOS Hello World to test everythink works as neeeded)
<img src="helloworld/../images/Hello_World/Hello_Microblaze/pic7.png" alt="HB7" /></p>
</li>
<li>
<p>Click finish</p>
</li>
<li>
<p>Now we need to enable Vitis to access the right port. open the terminal and give permissions to access the port</p>
</li>
</ol>
<pre><code class="language-bash">sudo chmod 666 /dev/ttyUSB*
</code></pre>
<ol start="10">
<li>Before running, choose the right port in Vitis</li>
</ol>
<ul>
<li>Under Vitis Serial Terminal  (One tab to the left of defualt tab 'Console')</li>
<li>Press the green plus to add a serial connection.</li>
<li>Fill in the settings.
<img src="helloworld/../images/Hello_World/Hello_Microblaze/pic9.jfif" alt="HB9" /></li>
</ul>
<p>now you can run the program
11.  Go to the terminal of the MicroBlaze and the result should be -
<img src="helloworld/../images/Hello_World/Hello_Microblaze/pic8.png" alt="HB8" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="hello-ros"><a class="header" href="#hello-ros">Hello ROS</a></h1>
<p>In this tutorial we will explain step-by-step how to create a basic ROS application running on the MicroBlaze that transmit a few messages.</p>
<h3 id="downloading-xsa-and-starting-a-new-project"><a class="header" href="#downloading-xsa-and-starting-a-new-project">Downloading XSA and Starting a new project</a></h3>
<ol>
<li>Download the fallowing file, it includes all the needed hardware to run ROS on the Microblaze:
<a href="helloworld/../files/Hello_World/Hello_ROS/design_Ultra96_MicroBlaze_wrapper.xsa">ROS_design.xsa</a></li>
<li>Start a new 'Hello Microblaze' project like descibed in <a href="helloworld/hello-microblaze.html">Hello Microblaze</a></li>
<li>Change the 'freertos_hello_world.c' to the fallowing <a href="helloworld/../files/Hello_ROS/freertos_hello_world.c">file</a>.</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="add-uart"><a class="header" href="#add-uart">Add UART</a></h1>
<h2 id="first-step--add-output-of-irq-from-zynq-to-microblaze"><a class="header" href="#first-step--add-output-of-irq-from-zynq-to-microblaze">First Step – Add output of IRQ from ZYNQ to MicroBlaze</a></h2>
<p>We want to connect PS_PL_irq_uart1 line from ZYNQ to MB xlconcat ip</p>
<ol>
<li>Double click on ZYNQ IP to open Re-customize IP window.</li>
<li>Add output to ZYNQ - Go to PS-PL Configuration.</li>
<li>In the window choose - General-&gt;Interruptd-&gt;PS to PL-&gt;UART-UART1 and set to 1
<img src="images/UART/UART_1.png" alt="UART1" /></li>
<li>Connect port to MicroBlaze change xlconcat  size to 2 and connect to ZYNQ PS_PL_irq_uart, Click Validate design</li>
</ol>
<h2 id="second-step--add-axi-connection-to-microblaze-not-sure-if-necessary"><a class="header" href="#second-step--add-axi-connection-to-microblaze-not-sure-if-necessary">Second Step – Add AXI Connection to MicroBlaze (not sure if necessary)</a></h2>
<ol>
<li>Add ports to ZYNQ:
<ul>
<li>Go to PS-PL Configuration.</li>
<li>In the window, choose Slave Interface -&gt; AXI HP -&gt; AXI LPD and set ‘v’.</li>
<li>Make sure AXI LPD Data Width is 12.<br />
<img src="images/UART/UART_2.png" alt="UART2" /></li>
</ul>
</li>
<li>Connect to bus:
<ul>
<li>Run connection automation.</li>
</ul>
</li>
</ol>
<p>There might be a good explanation here: <a href="https://support.xilinx.com/s/article/1175350?language=en_US">Xilinx Support</a></p>
<!--stackedit_data:
eyJoaXN0b3J5IjpbLTE2OTAxNDU0MjMsLTE4NDIwOTE0MTQsNz
MwOTk4MTE2XX0=
-->
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-to-create-ros-project-in-vitis"><a class="header" href="#how-to-create-ros-project-in-vitis">How to create ROS project in vitis</a></h1>
<h2 id="step-1-copy-ros-c-files-to-src-directory"><a class="header" href="#step-1-copy-ros-c-files-to-src-directory">Step 1: Copy ROS .c Files to src Directory</a></h2>
<ul>
<li>Copy necessary .c files (e.g., allocator) to the <code>src</code> directory.</li>
<li>These files contain functions for micro-ROS, and the main files to run the program.</li>
</ul>
<h3 id="files-1"><a class="header" href="#files-1">Files:</a></h3>
<p>All files needed to run uROS.<br />
<a href="files/Vitis/main.c">main.c</a><br />
<a href="files/Vitis/custom_memory_manager.c">custom_memory_manager.c</a><br />
<a href="files/Vitis/microros_allocator.c">microros_allocator.c</a><br />
<a href="files/Vitis/microros_time.c">microros_time.c</a><br />
<a href="files/Vitis/uart_transport.c">uart_transport.c</a></p>
<h2 id="step-2-create-a-link-for-the-micro-ros-directories"><a class="header" href="#step-2-create-a-link-for-the-micro-ros-directories">Step 2: Create a Link for the micro-ROS Directories</a></h2>
<ul>
<li>Go to the properties of the project.<br />
<img src="images/ROS_PRJ/PRJ_1.jpg" alt="PRJ1" /></li>
<li>Navigate to: <code>C/C++ Build -&gt; Settings -&gt; MicroBlaze gcc compiler -&gt; Directories</code>.<br />
<img src="images/ROS_PRJ/PRJ_2.jpg" alt="PRJ2" /></li>
<li>Click "Add" (top right corner of the screen).</li>
<li>Insert the link to the <code>microblaze_ws</code> include file: <code>/&lt;path&gt;/microros_ws/firmware/build/include</code>.</li>
</ul>
<h2 id="step-3-create-a-link-for-the-a-file"><a class="header" href="#step-3-create-a-link-for-the-a-file">Step 3: Create a Link for the .a File</a></h2>
<ul>
<li>Go to the properties of the project (same as before).</li>
<li>Navigate to: <code>C/C++ Build -&gt; Settings -&gt; MicroBlaze gcc linker -&gt; Libraries</code>.</li>
<li>There are two boxes there:<br />
<img src="images/ROS_PRJ/PRJ_3.jpg" alt="PRJ3" /></li>
</ul>
<!---  - Under "Library search path," click "Add" (top right corner of the lower box).\ --->
<ul>
<li>Under "Libary search path (-L)" insert the path to the <code>.a</code> file (the folder of the <code>.a</code> file): <code>/&lt;path&gt;/microros_ws/firmware/build/</code>.</li>
<li>Under "Libraries (-l)," click "Add" (top right corner of the upper box) and add the flag <code>microros</code>.
<img src="images/ROS_PRJ/PRJ_9.png" alt="PRJ9" /></li>
</ul>
<h2 id="step-4-configure-uart-for-microblaze"><a class="header" href="#step-4-configure-uart-for-microblaze">Step 4: Configure UART for microblaze</a></h2>
<ul>
<li>Ensure the input to the microblaze is the UART:
<ul>
<li>Under the design wrapper/platform (green box), go to <code>platform.spr</code>.<br />
<img src="images/ROS_PRJ/PRJ_4.png" alt="PRJ4" /></li>
<li>Navigate to: <code>Board Support Package -&gt; Modify BSP Settings</code>.<br />
<img src="images/ROS_PRJ/PRJ_5.png" alt="PRJ5" /></li>
<li>Go to <code>Overview -&gt; Standalone</code> and change <code>stdin</code> and <code>stdout</code> to <code>psu_uart_1</code> (and click OK).<br />
<img src="images/ROS_PRJ/PRJ_6.png" alt="PRJ6" /></li>
</ul>
</li>
</ul>
<h2 id="step-5-address-problem-with-micro-ros-directories"><a class="header" href="#step-5-address-problem-with-micro-ros-directories">Step 5: Address Problem with micro-ROS Directories</a></h2>
<ul>
<li>Due to changes in the directory structure of micro-ROS, there might be problems building the code. Additional directories need to be included for the compiler.</li>
<li>Go to the properties of the project.</li>
<li>Navigate to: <code>C/C++ Build -&gt; Settings -&gt; MicroBlaze gcc compiler -&gt; Directories</code>.</li>
<li>Click "Add" (top right corner of the screen).
<img src="images/ROS_PRJ/PRJ_7.jpg" alt="PRJ7" /></li>
<li>Insert the link to the first directory in the tree for each missing file. For example: <code>/&lt;path&gt;/microros_ws/firmware/build/include/rcl</code>.
<ul>
<li>
<p>The file itself is at: <code>/&lt;path&gt;/microros_ws/firmware/build/include/rcl/rcl/rcl.h</code>.</p>
<p><img src="images/ROS_PRJ/PRJ_8.png" alt="PRJ8" /></p>
</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="gpio--interrupts"><a class="header" href="#gpio--interrupts">GPIO &amp; Interrupts</a></h1>
<p>We created for testing 2 AXI_GPIO objects: one for inputs and one for outputs. Then we enabled interrupts for the AXI_GPIO used for inputs and connected it to the interrupt controller.</p>
<h2 id="hardware-side"><a class="header" href="#hardware-side">Hardware Side</a></h2>
<h3 id="add-axi_gpio-block"><a class="header" href="#add-axi_gpio-block">Add AXI_GPIO Block</a></h3>
<ol>
<li>First step is to ad the IP. right click on the mouse and choose ADD IP. Then you need to choose the wanted IP and add it to the design.
<img src="images/GPIO/GPIO_0.jpeg" alt="GPIO0" /></li>
<li>Set all inputs/all outputs for simple use.
<img src="images/GPIO/GPIO_1.png" alt="GPIO1" /></li>
<li>Use “Run Connection Automation” (it will add this part that we will remove later).
<img src="images/GPIO/GPIO_2.png" alt="GPIO2" /></li>
</ol>
<h3 id="connect-to-external-gpio-pins-and-etc"><a class="header" href="#connect-to-external-gpio-pins-and-etc">Connect to External GPIO (pins and etc.)</a></h3>
<ol>
<li>Press the ‘+’ near the word GPIO and then right-click on the line under and choose make external.
<img src="images/GPIO/GPIO_3.png" alt="GPIO3" /></li>
<li>Now we can delete the wire and pin connected to the GPIO name (in orange).
<img src="images/GPIO/GPIO_4.png" alt="GPIO4" /></li>
</ol>
<h3 id="define-the-physical-connection"><a class="header" href="#define-the-physical-connection">Define the Physical Connection</a></h3>
<ol>
<li>Add a source file:
<ul>
<li>Go to ‘Source’ -&gt; ‘Constraints’ and then right-click and choose ‘Add Sources’.<br />
<img src="images/GPIO/GPIO_5.png" alt="GPIO5" /></li>
<li>Choose ‘Add or create constraints’.<br />
<img src="images/GPIO/GPIO_6.png" alt="GPIO6" /></li>
<li>Then choose create file.<br />
<img src="images/GPIO/GPIO_7.png" alt="GPIO7" /></li>
<li>Click ‘ok’ and then ‘finish’.</li>
</ul>
</li>
<li>Now open the file and add the code to config the board.<br />
<img src="images/GPIO/GPIO_8.png" alt="GPIO8" /></li>
</ol>
<h3 id="how-to-connect-the-ports-from-the-xsa-to-gpio"><a class="header" href="#how-to-connect-the-ports-from-the-xsa-to-gpio">How to Connect the Ports from the XSA to GPIO</a></h3>
<ol>
<li>We will define 2 things for each port: their type (voltage) and actual connection (need to find the pin mapping of the board; D7 is an example):
<pre><code class="language-tcl">set_property IOSTANDARD LVCMOS18 [get_ports {pin_out[0]}]
set_property PACKAGE_PIN D7 [get_ports {pin_out[0]}]
</code></pre>
The command <code>[get_ports {pin_out[0]}]</code> returns the object of the <code>pin_out[0]</code> (the name we chose for the port).</li>
</ol>
<h4 id="example"><a class="header" href="#example">Example:</a></h4>
<p>An example of a project with 2 AXI GPIO devices. one for input ports and one for output ports.
<img src="images/GPIO/GPIO_14.jpeg" alt="GPIO8" />
<img src="images/GPIO/GPIO_13.png" alt="GPIO8" /></p>
<p>The corresponding xdc file</p>
<pre><code class="language-tcl"># HD_GPIO0 / connector 3
set_property PACKAGE_PIN D7 [get_ports gpio_io_o_0[0]]
    set_property IOSTANDARD LVCMOS18 [get_ports gpio_io_o_0[0]]
    
# HD_GPIO1 / connector 5
set_property PACKAGE_PIN F8 [get_ports gpio_io_o_0[1]]
    set_property IOSTANDARD LVCMOS18 [get_ports gpio_io_o_0[1]]
    
# HD_GPIO2 / connector 7
set_property PACKAGE_PIN F7 [get_ports gpio_io_i_0[0]]
    set_property IOSTANDARD LVCMOS18 [get_ports gpio_io_i_0[0]]
    
# HD_GPIO3/ connector 9
set_property PACKAGE_PIN G7 [get_ports gpio_io_i_0[1]]
    set_property IOSTANDARD LVCMOS18 [get_ports gpio_io_i_0[1]]
</code></pre>
<h3 id="connect-interrupts"><a class="header" href="#connect-interrupts">Connect Interrupts</a></h3>
<ol>
<li>Open the AXI_GPIO properties and choose “enable interrupts”.<br />
<img src="images/GPIO/GPIO_9.png" alt="GPIO9" /></li>
<li>In our design, the interrupt controller <code>intr</code> (interrupt request) is connected through the “Concat” object.<br />
<img src="images/GPIO/GPIO_10.png" alt="GPIO10" /></li>
<li>We will go to the Concat object and add a port. Then we will manually connect the irq pin from the AXI_GPIO to the open In pin.<br />
<img src="images/GPIO/GPIO_11.png" alt="GPIO11" /></li>
<li>Then press “Validate design” and you will see the added input to the interrupt controller.<br />
<img src="images/GPIO/GPIO_12.png" alt="GPIO12" /></li>
</ol>
<h2 id="software-side"><a class="header" href="#software-side">Software Side</a></h2>
<p>After we create a project with the AXI GPIO block we will have some new files we can include (we won’t be able to include these files if there is no AXI_GPIO IP in the XSA file).</p>
<h3 id="needed-includes"><a class="header" href="#needed-includes">Needed Includes</a></h3>
<pre><code class="language-c">/* GPIO includes */
#include "xil_io.h"
#include "xgpio.h"
</code></pre>
<h3 id="defines-of-the-axi-gpio-ips"><a class="header" href="#defines-of-the-axi-gpio-ips">Defines of the AXI GPIO IPs</a></h3>
<p>We had one IP for inputs and one for outputs. The LED defines are for choosing which pins to use. The channel is in case you enabled 2 channels in the Vivado for the AXI_GPIO object. We found the ID in “/&lt;project_name&gt;/export/&lt;project_name&gt;/sw/&lt;project_name&gt;/freertos10_xilinx_microblaze_0/bspinclude/include/xparameters.h”.</p>
<pre><code class="language-c">/* GPIO defines */
#define GPIO_DEVICE_ID_OUT      XPAR_GPIO_0_DEVICE_ID       // ID of the GPIO object
#define LED                     0x01
#define LED_CH                  1
#define LED_DEL                 10000000

#define GPIO_DEVICE_ID_IN       XPAR_GPIO_1_DEVICE_ID
</code></pre>
<h3 id="create-object-class-that-will-work-with-the-ip"><a class="header" href="#create-object-class-that-will-work-with-the-ip">Create Object (“class”) that will Work with the IP</a></h3>
<pre><code class="language-c">/* GPIO variables */
XGpio Gpio_out;
XGpio Gpio_in;
</code></pre>
<h3 id="initialize-and-perform-readwrite"><a class="header" href="#initialize-and-perform-readwrite">Initialize and Perform Read/Write</a></h3>
<pre><code class="language-c">// INIT GPIO OUT OBJECT
Status = XGpio_Initialize(&amp;Gpio_out, GPIO_DEVICE_ID_OUT);
if (Status != XST_SUCCESS) {
    xil_printf("GPIO OUT INIT fail!");
}
// Write to GPIO object
XGpio_DiscreteWrite(&amp;Gpio_out, LED_CH, BUTTON_VOLTAGE); // set GPIO to OFF maybe set to 0x01 for as voltage src

// INIT GPIO IN OBJECT
Status = XGpio_Initialize(&amp;Gpio_in, GPIO_DEVICE_ID_IN);
if (Status != XST_SUCCESS) {
    xil_printf("GPIO IN INIT fail!");
}
// Read from GPIO object
button_red_1 = XGpio_DiscreteRead(&amp;Gpio_in, BUTTON_CH);
</code></pre>
<h3 id="work-with-interrupts"><a class="header" href="#work-with-interrupts">Work with Interrupts</a></h3>
<p>Because we work with an operating system, we need to create a function that will work as ISR and then let the OS do the rest of the work. In general, you need to tell the OS which function will be used as ISR.</p>
<p>Good explanation: <a href="https://www.freertos.org/RTOS-Xilinx-Microblaze-KC705.html#implementing_an_ISR">FreeRTOS Xilinx MicroBlaze</a></p>
<p>In general:</p>
<ol>
<li>Get the ISR id. You will have the define <code>XPAR_INTC_0_GPIO_1_VEC_ID</code> under “/&lt;project_name&gt;/export/&lt;project_name&gt;/sw/&lt;project_name&gt;/freertos10_xilinx_microblaze_0/bspinclude/include/xparameters.h”.</li>
<li>Get the interrupt controller id. You will have the define <code>XPAR_INTC_0_DEVICE_ID</code> under “/&lt;project_name&gt;/export/&lt;project_name&gt;/sw/&lt;project_name&gt;/freertos10_xilinx_microblaze_0/bspinclude/include/xparameters.h”.</li>
<li>Declare the function that will be used as ISR.</li>
<li>Use <code>xPortInstallInterruptHandler</code> to set the function as interrupt handler.</li>
<li>Enable interrupt with <code>vPortEnableInterrupt</code>.</li>
</ol>
<pre><code class="language-c">/* Interrupts */
#define INTC_DEVICE_ID          XPAR_INTC_0_DEVICE_ID
#define INTC_DEVICE_INT_ID      XPAR_INTC_0_GPIO_1_VEC_ID
Status = xPortInstallInterruptHandler(INTC_DEVICE_INT_ID, myInterruptHandler, NULL);
vPortEnableInterrupt(INTC_DEVICE_INT_ID);
</code></pre>
<h3 id="current-problem"><a class="header" href="#current-problem">Current Problem</a></h3>
<p>These 2 functions are defined in the <code>portmacro.h</code> file with <code>uint8_t</code> as the first argument. In the <code>port.c</code> files, there is a define <code>XPAR_XILTIMER_ENABLED</code> that sets the first argument as <code>uint16_t</code> and that creates the error “undefined reference to <code>xPortInstallInterruptHandler</code>”.</p>
<p>In order to let the function compile, we need to set this var to 0.</p>
<p>Right now the interrupts don’t work.</p>
<!--stackedit_data:
eyJoaXN0b3J5IjpbLTgzODY1MDA1NCw3MzA5OTgxMTZdfQ==
-->
<div style="break-before: page; page-break-before: always;"></div><h1 id="using-polling-to-send-rtos-messages"><a class="header" href="#using-polling-to-send-rtos-messages">Using Polling to Send RTOS Messages</a></h1>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>This project demonstrates the use of polling to send messages in a Real-Time Operating System (RTOS) environment using FreeRTOS on an Ultra96 board with MicroBlaze. The project involves toggling an LED using GPIO and publishing messages via micro-ROS.</p>
<p>The fallowing code uses the latest XSA <a href="files/Vivado/Ultra96_MicroBlaze_ddr_gpio_v2.xsa">file</a>.
The latest code <a href="files/Vitis/">files</a></p>
<h2 id="project-structure"><a class="header" href="#project-structure">Project Structure</a></h2>
<h3 id="includes"><a class="header" href="#includes">Includes</a></h3>
<ol>
<li><strong>FreeRTOS Includes</strong>:
<ul>
<li><code>FreeRTOS.h</code>, <code>task.h</code>, <code>queue.h</code>, <code>timers.h</code></li>
</ul>
</li>
<li><strong>Xilinx Includes</strong>:
<ul>
<li><code>xil_printf.h</code>, <code>xparameters.h</code>, <code>xuartps.h</code></li>
</ul>
</li>
<li><strong>GPIO Includes</strong>:
<ul>
<li><code>xil_io.h</code>, <code>xgpio.h</code></li>
</ul>
</li>
<li><strong>micro-ROS Includes</strong>:
<ul>
<li><code>rcl/rcl.h</code>, <code>rcl/error_handling.h</code>, <code>rclc/rclc.h</code>, <code>rclc/executor.h</code>, <code>rmw_microxrcedds_c/config.h</code>, <code>rmw_microros/rmw_microros.h</code></li>
<li>ROS message includes: <code>std_msgs/msg/int64.h</code>, <code>std_msgs/msg/int32.h</code>, <code>sensor_msgs/msg/image.h</code></li>
</ul>
</li>
</ol>
<h3 id="defines"><a class="header" href="#defines">Defines</a></h3>
<ol>
<li><strong>Hello World Defines</strong>:
<ul>
<li><code>DELAY_1_SECOND</code> (1000UL)</li>
</ul>
</li>
<li><strong>GPIO Defines</strong>:
<ul>
<li><code>GPIO_DEVICE_ID_OUT</code> (XPAR_GPIO_0_DEVICE_ID), <code>LED</code> (0x01), <code>LED_CH</code> (1), <code>LED_DEL</code> (10000000)</li>
<li><code>GPIO_DEVICE_ID_IN</code> (XPAR_GPIO_1_DEVICE_ID), <code>BUTTON_VOLTAGE</code> (0x02), <code>BUTTON</code> (0x03), <code>BUTTON_CH</code> (1)</li>
</ul>
</li>
</ol>
<h3 id="variables"><a class="header" href="#variables">Variables</a></h3>
<ul>
<li>GPIO variables: <code>XGpio Gpio_out</code>, <code>XGpio Gpio_in</code>, <code>u32 button_red_1</code>, <code>u32 button_red_2</code>, <code>static TaskHandle_t toggleLEDTask</code></li>
</ul>
<h3 id="tasks"><a class="header" href="#tasks">Tasks</a></h3>
<ol>
<li><strong>LED Task</strong>:
<ul>
<li>Function: <code>toggleLED</code></li>
<li>Description: Toggles an LED based on GPIO input.</li>
</ul>
</li>
</ol>
<h3 id="functions"><a class="header" href="#functions">Functions</a></h3>
<ol>
<li>
<p><strong>Main Function</strong>:</p>
<ul>
<li>Initializes GPIO for output and input.</li>
<li>Creates tasks for toggling LED and micro-ROS message publication.</li>
<li>Starts the FreeRTOS scheduler.</li>
</ul>
</li>
<li>
<p><strong>toggleLED</strong>:</p>
<ul>
<li>Toggles the LED and reads the button status every second.</li>
</ul>
</li>
<li>
<p><strong>microros_init</strong>:</p>
<ul>
<li>Initializes micro-ROS with custom transport and allocator.</li>
</ul>
</li>
<li>
<p><strong>microros_msg_pub</strong>:</p>
<ul>
<li>Publishes a standard message (Int32) every second.</li>
</ul>
</li>
<li>
<p><strong>microros_thread_custom</strong>:</p>
<ul>
<li>Initializes micro-ROS node and publisher for image messages.</li>
</ul>
</li>
</ol>
<h2 id="example-image-data"><a class="header" href="#example-image-data">Example Image Data</a></h2>
<p>Two sample images (<code>coffee</code> and <code>time</code>) are provided as arrays of pixel values.</p>
<h2 id="constants"><a class="header" href="#constants">Constants</a></h2>
<p>Several constants are defined for delays and UART configuration:</p>
<ul>
<li><code>TIMER_ID</code>, <code>DELAY_10_SECONDS</code>, <code>DELAY_1_SECOND</code>, <code>DELAY_60_SECOND</code>, <code>DELAY_30_SECOND</code>, <code>DELAY_10_MS</code>, <code>TIMER_CHECK_THRESHOLD</code></li>
<li><code>UART_DEVICE_ID</code>, <code>THREAD_MIRCOROS_STACKSIZE</code></li>
<li><code>MICROROS_TRANSPORTS_FRAMING_MODE</code>, <code>MICROROS_TRANSPORTS_PACKET_MODE</code></li>
</ul>
<h2 id="micro-ros-custom-transport"><a class="header" href="#micro-ros-custom-transport">Micro-ROS Custom Transport</a></h2>
<p>Custom transport functions are provided for micro-ROS communication:</p>
<ul>
<li><code>vitis_transport_open</code>, <code>vitis_transport_close</code>, <code>vitis_transport_write</code>, <code>vitis_transport_read</code></li>
<li>Memory management functions: <code>microros_allocate</code>, <code>microros_deallocate</code>, <code>microros_reallocate</code>, <code>microros_zero_allocate</code></li>
</ul>
<h2 id="node-and-topic-definitions"><a class="header" href="#node-and-topic-definitions">Node and Topic Definitions</a></h2>
<ul>
<li>Node name: <code>vitis_publisher</code></li>
<li>Topic names: <code>ros_pub_img_topic_name</code> ("image_raw"), <code>ros_pub_msg_topic_name</code> ("img_detection")</li>
</ul>
<h2 id="usage"><a class="header" href="#usage">Usage</a></h2>
<p>Compile and load the code onto the Ultra96 board. Ensure that FreeRTOS and micro-ROS libraries are properly linked. The program will toggle an LED based on GPIO input and publish messages via micro-ROS.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="running-everthing"><a class="header" href="#running-everthing">Running everthing</a></h1>
<p>Steps to fallow in ORDER!:</p>
<ul>
<li><a href="running.html#open-vitis">Open Vitis</a></li>
<li><a href="running.html#uros">uROS</a></li>
<li><a href="running.html#run-fpga">Run FPGA</a></li>
<li><a href="running.html#tools">Tools</a></li>
</ul>
<h2 id="open-vitis"><a class="header" href="#open-vitis">Open Vitis</a></h2>
<ol>
<li>Open NEW terminal:</li>
<li>write <code>source /tools/Xilinx/Vitis/2022.2/settings64.sh</code></li>
<li>write <code>vitis</code> in terminal</li>
</ol>
<h2 id="uros"><a class="header" href="#uros">uROS</a></h2>
<ol>
<li>Enter workspace:</li>
</ol>
<pre><code class="language-bash">cd microros_ws/
</code></pre>
<ol start="2">
<li>Make sure xilinx board USB is connected and visable:</li>
</ol>
<pre><code class="language-bash">ll /sys/class/tty/ttyUSB*
</code></pre>
<h3 id="open-two-terminals"><a class="header" href="#open-two-terminals">Open two terminals:</a></h3>
<h4 id="terminal-1"><a class="header" href="#terminal-1">Terminal 1:</a></h4>
<ol start="3">
<li>Soruce uROS:</li>
</ol>
<pre><code class="language-bash">source install/local_setup.bash
</code></pre>
<ol start="4">
<li>Allow non-root/ros2 access to USB (Please re-run with superuser privileges):</li>
</ol>
<pre><code class="language-bash">sudo chmod 666 /dev/ttyUSB*
</code></pre>
<blockquote>
<p>[!TIP]<br />
This command needs to be used every time a serial connection is desired between the FPGA and Linux machine</p>
</blockquote>
<ol start="5">
<li>Running the micro-ROS app:</li>
</ol>
<pre><code class="language-bash">ros2 run micro_ros_agent micro_ros_agent serial --dev /dev/serial/by-id/usb-Xilinx_JTAG+Serial_1234-oj1-if01-port0 -v 6
</code></pre>
<h2 id="run-fpga"><a class="header" href="#run-fpga">Run FPGA</a></h2>
<ol>
<li>Build Project :hammer:</li>
<li>Debug As -&gt; Launch Hardware</li>
</ol>
<h2 id="tools"><a class="header" href="#tools">Tools</a></h2>
<ol>
<li>Open new terminal and soruces uROS:</li>
</ol>
<pre><code class="language-bash">source install/local_setup.bash
</code></pre>
<ol start="2">
<li>Subscribe to micro-ROS ping topic</li>
</ol>
<pre><code class="language-bash">ros2 topic echo /vitis_publisher
</code></pre>
<p>or</p>
<pre><code class="language-bash">rqt
</code></pre>
<p>    Inside the RQT window: Plugin -&gt; Visulatasions -&gt; Image View</p>
<h2 id="usfull-commends"><a class="header" href="#usfull-commends">Usfull Commends</a></h2>
<p>Find all topics on grath:</p>
<pre><code class="language-bash">ros2 topic list
</code></pre>
<p>Print data foing through a topic:</p>
<pre><code class="language-bash">ros2 topic echo /topic
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="image-pipline"><a class="header" href="#image-pipline">Image Pipline</a></h1>
<p>Tutorial from <a href="https://jeffzzq.medium.com/ros2-image-pipeline-tutorial-3b18903e7329">ROS2 Image Pipeline Tutorial</a></p>
<p>if new WS is needed:</p>
<pre><code class="language-bash">mkdir test_ws
cd test_ws
mkdir src
</code></pre>
<p>else</p>
<pre><code class="language-bash">cd ~/ros2_ws
</code></pre>
<p>then:</p>
<pre><code class="language-bash">cd src
git clone https://github.com/ros-perception/image_pipeline.git
git clone https://github.com/ros-perception/image_common.git
git clone https://github.com/clydemcqueen/opencv_cam.git
git clone https://github.com/ptrmu/ros2_shared.git

cd ..
colcon build
ros2 pkg executables
</code></pre>
<p>fined connected camera devices:</p>
<pre><code class="language-bash">ls /dev/video*
/dev/video0  /dev/video1
</code></pre>
<p>"/dev/video0"  worked for me (camera_num = 0)</p>
<pre><code class="language-bash">. install/local_setup.bash
ros2 run opencv_cam opencv_cam_main --ros-args --param index:=&lt;camera_num&gt;
</code></pre>
<p>in new terminal:</p>
<pre><code class="language-bash">$ . install/local_setup.bash$ ros2 topic list
/image_raw
/parameter_events
/rosout$ 

$ ros2 topic echo --no-arr /image_raw
	header:
	  stamp:
	    sec: 1610063135
	    nanosec: 248209953
	  frame_id: camera_frame
	height: 720
	width: 1280
	encoding: bgr8
	is_bigendian: 0
	step: 3840
	data: '&lt;sequence type: uint8, length: 2764800&gt;'
	---

$ ros2 run image_view image_view --ros-args --remap /image:=/image_raw
	
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="files-2"><a class="header" href="#files-2">Files</a></h1>
<h2 id="xsa-files-for-vivado"><a class="header" href="#xsa-files-for-vivado">XSA files for Vivado</a></h2>
<ul>
<li><a href="files/Vivado/Ultra96_MicroBlaze_ddr.xsa">with GPIO DDR</a></li>
<li><a href="files/Vivado/Ultra96_MicroBlaze_ddr_gpio_v2.xsa">w/out GPIO</a></li>
</ul>
<h2 id="code-for-vitis"><a class="header" href="#code-for-vitis">Code for Vitis</a></h2>
<ul>
<li><a href="files/Vitis/final_code.zip">final code</a></li>
</ul>
<h2 id="workstations"><a class="header" href="#workstations">Workstations</a></h2>
<ul>
<li><a href="files/uROS/microros.zip">micro ROS WS</a></li>
<li><a href="files/uROS/ros_ws.zip">ROS2 WS</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
