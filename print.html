<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>ROS Project 2024</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">Introduction</a></li><li class="chapter-item expanded "><a href="download-xilinx.html"><strong aria-hidden="true">1.</strong> Download Xlinix</a></li><li class="chapter-item expanded "><a href="install-ros.html"><strong aria-hidden="true">2.</strong> Install ROS</a></li><li class="chapter-item expanded "><a href="add-uart.html"><strong aria-hidden="true">3.</strong> Add UART</a></li><li class="chapter-item expanded "><a href="ros-proj-in-vitis.html"><strong aria-hidden="true">4.</strong> ROS project in vitis</a></li><li class="chapter-item expanded "><a href="gpio-n-interrupts.html"><strong aria-hidden="true">5.</strong> GPIO & Interrupts</a></li><li class="chapter-item expanded "><a href="new-vitis-proj.html"><strong aria-hidden="true">6.</strong> Create New Vitis Project</a></li><li class="chapter-item expanded "><a href="code-over-view.html"><strong aria-hidden="true">7.</strong> Code Over View</a></li><li class="chapter-item expanded "><a href="running.html"><strong aria-hidden="true">8.</strong> Running everthing</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">ROS Project 2024</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<h2 id="todo"><a class="header" href="#todo">TODO:</a></h2>
<ul>
<li><input disabled="" type="checkbox"/>
Add files to md book vivido project and XSA file (check we can send vivato project proparly)</li>
<li><input disabled="" type="checkbox" checked=""/>
Review files</li>
<li><input disabled="" type="checkbox"/>
Add chapters from Michael? (How to download vitas and so on….)</li>
<li><input disabled="" type="checkbox"/>
Update introduction (using linux versions and so on)</li>
<li><input disabled="" type="checkbox"/>
In the create vitas project , maybe change the code, because it includes GPIO</li>
<li><input disabled="" type="checkbox"/>
Chapter with finished code (ROS controller by GPIO)</li>
<li><input disabled="" type="checkbox"/>
Link to XSA file inside create Vitis project</li>
<li><input disabled="" type="checkbox"/>
Publish book</li>
<li><input disabled="" type="checkbox"/>
Add Code over view
<ul>
<li><input disabled="" type="checkbox"/>
Stack size</li>
</ul>
</li>
<li><input disabled="" type="checkbox"/>
How to run. (finish)
<ul>
<li><input disabled="" type="checkbox"/>
Add chapter of run ros on computer</li>
<li>first open ROS in terminal, then build project then run project</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="download-software"><a class="header" href="#download-software">Download Software</a></h1>
<h2 id="basic-information"><a class="header" href="#basic-information">Basic Information</a></h2>
<p>In our project we will use the software called Vitis unified software platform from Xilinx
It includes 2 main softwares</p>
<ol>
<li>Vitis – IDE for programing ther FPGA and running the code</li>
<li>Vivado – for creating the hardware for the FPGA</li>
</ol>
<p>This is a tool  that combines all aspects of Xilinx® software development into one unified environment. The Vitis software platform supports both the Vitis embedded software development flow, for Xilinx Software Development Kit (SDK) users looking to move into the next generation technology, and the Vitis application acceleration development flow, for software developers looking to use the latest in Xilinx FPGA-based software acceleration.</p>
<p>The Vitis™ software platform consists of an integrated design environment (IDE) for interactive project development, and command-line tools for scripted or manual application development. The Vitis software platform also includes the Vivado® Design Suite for implementing the kernel on the target device, and for developing custom hardware platforms.</p>
<h2 id="download-files"><a class="header" href="#download-files">Download files</a></h2>
<ul>
<li><a href="https://www.xilinx.com/support/download/index.html/content/xilinx/en/downloadNav/vitis.html">Downloads</a></li>
</ul>
<p>Go to Vitis (SW Developer) and download the installer for your operating system</p>
<p>We worked with version 2022.2: (Linux and windows versions)</p>
<h2 id="installation-tutorial-windows"><a class="header" href="#installation-tutorial-windows">Installation Tutorial (Windows)</a></h2>
<ol>
<li>open .EXE file</li>
<li>click next<br />
<img src="images/Dowload_Xilinx/download_software1.png" alt="pic" /></li>
<li>Login to your account of xilinx (if you don’t have, register one)<br />
<img src="images/Dowload_Xilinx/download_software2.png" alt="pic" /></li>
<li>Choose Vitis<br />
<img src="images/Dowload_Xilinx/download_software3.png" alt="pic" /></li>
<li>In the next screen, we need to choose the products we want to install. For the full installation you will need 245 GB disk space<br />
<img src="images/Dowload_Xilinx/download_software4.png" alt="pic" />
If you don’t have the space requirement, the only products we need to choose for our project are:<br />
<img src="images/Dowload_Xilinx/download_software5.png" alt="pic" /></li>
</ol>
<p>For the SoCs, you can also remove Zynq-7000 and Zynq UltraScale + RFSoC because our board is Zynq UltraScale + MPSoC. The vitis Model composer is also optional so if you still don’t have enough disk space, buy a new one</p>
<ol start="7">
<li>Click i agree to all the license agreements and then install regualry\</li>
</ol>
<h2 id="installation-tutorial-linux"><a class="header" href="#installation-tutorial-linux">Installation Tutorial (Linux)</a></h2>
<p>Download the installer from the download page only this time choose the one for linux</p>
<ol>
<li>
<p>Right click on the bin file → properties → Permissions → Check the Execute option<br />
<img src="images/Dowload_Xilinx/download_software6.png" alt="pic" /></p>
</li>
<li>
<p>Open Terminal inside the folder contains the bin file (Or open terminal then cd to the path contains the bin file)</p>
</li>
<li>
<p>Run the following commands:  (To get the file name easy)</p>
</li>
</ol>
<pre><code class="language-bash">	ls -ltr
</code></pre>
<ol start="4">
<li>
<p>Then type the command: sudo ./<em>File_Name</em>
For example:<br />
<img src="images/Dowload_Xilinx/download_software7.png" alt="pic" /></p>
</li>
<li>
<p>then type your password and then it should open the xilinx installer<br />
<img src="images/Dowload_Xilinx/download_software8.png" alt="pic" /></p>
</li>
<li>
<p>Then its the same like for the windows.</p>
</li>
<li>
<p>Open terminal and type in the command (check the vitas version):</p>
</li>
</ol>
<pre><code class="language-bash">	source &lt;Vitis_install_path&gt;/Vitis/2022.2/settings64.sh
</code></pre>
<p>In my case the path was:</p>
<pre><code class="language-bash">/tools/Xilinx/Vitis/2022.2/settings64.sh
</code></pre>
<p>Then to lunch the vitis ide type in</p>
<pre><code class="language-bash">vitis
</code></pre>
<p>(For the other apps like vivado, vitis_hls do the same just source to the right path)</p>
<h2 id="installing-cable-drivers-only-for-linux"><a class="header" href="#installing-cable-drivers-only-for-linux">Installing Cable Drivers (Only for linux)</a></h2>
<p>During the installtion we can’t select the option to install the cable drivers and it needs to be done manually:</p>
<pre><code class="language-bash">cd &lt;install drivers path&gt;
</code></pre>
<p>in  my case it was</p>
<pre><code class="language-bash">&lt;Vitis Install&gt;/data/xicom/cable_drivers/lin64/install_script/install_drivers/
</code></pre>
<p><img src="images/Dowload_Xilinx/download_softwar9.png" alt="pic" /></p>
<p>then run the command:</p>
<pre><code class="language-bash">sudo ./install_drivers
</code></pre>
<p><img src="images/Dowload_Xilinx/download_software10.png" alt="pic" /></p>
<h3 id="possible-error"><a class="header" href="#possible-error">Possible Error</a></h3>
<p>If the installer hang on the "Generating installed device list" step
Open terminal and type in the command:</p>
<pre><code class="language-bash">	sudo apt-get install libtinfo5
</code></pre>
<p>as documented <a href="https://support.xilinx.com/s/article/76616?language=en_US">here</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="install-ros-and-create-micro-ros-firmware-inside-ubuntu-2204"><a class="header" href="#install-ros-and-create-micro-ros-firmware-inside-ubuntu-2204">Install ROS and Create micro-ROS Firmware inside Ubuntu 22.04</a></h1>
<h2 id="install-ros-2"><a class="header" href="#install-ros-2">Install ROS 2</a></h2>
<p>Use the following link to download and set up ROS 2:<br />
<a href="https://docs.ros.org/en/humble/Installation/Ubuntu-Install-Debians.html">ROS 2 Installation Instructions</a></p>
<p>Follow these steps inside the page:</p>
<ol>
<li>
<p>Set locale (you can use the following to check if OS supports UTF-8 in your terminal)</p>
<pre><code class="language-bash">echo -e '\xe2\x82\xac'
</code></pre>
<p>if UTF-8 is supported it should print out euro symbol</p>
<pre><code class="language-bash">€
</code></pre>
</li>
<li>
<p>Setup Sources</p>
</li>
<li>
<p>Install ROS 2 packages</p>
</li>
<li>
<p>Environment setup</p>
</li>
</ol>
<h2 id="install-micro-ros-build-system"><a class="header" href="#install-micro-ros-build-system">Install micro-ROS Build System</a></h2>
<p>Now we need to create the micro-ROS build system.
The following steps were taken from (there is no need to use the link):<br />
<a href="https://micro.ros.org/docs/tutorials/core/first_application_rtos/freertos/">micro-ROS Build System Instructions</a></p>
<p>Make sure to replace <code>ROS_DISTRO</code> with the desired ROS version for us its "humble".</p>
<h3 id="source-the-ros-2-installation"><a class="header" href="#source-the-ros-2-installation">Source the ROS 2 Installation</a></h3>
<pre><code class="language-bash">source /opt/ros/$ROS_DISTRO/setup.bash
</code></pre>
<h3 id="create-a-workspace-and-download-the-micro-ros-tools"><a class="header" href="#create-a-workspace-and-download-the-micro-ros-tools">Create a Workspace and Download the micro-ROS Tools</a></h3>
<pre><code class="language-bash">mkdir microros_ws
cd microros_ws
git clone -b $ROS_DISTRO https://github.com/micro-ROS/micro_ros_setup.git src/micro_ros_setup
</code></pre>
<h3 id="update-dependencies-using-rosdep"><a class="header" href="#update-dependencies-using-rosdep">Update Dependencies Using rosdep</a></h3>
<pre><code class="language-bash">sudo apt update &amp;&amp; rosdep update
rosdep install --from-paths src --ignore-src -y
</code></pre>
<h3 id="install-pip"><a class="header" href="#install-pip">Install pip</a></h3>
<pre><code class="language-bash">sudo apt-get install python3-pip
</code></pre>
<h3 id="build-micro-ros-tools-and-source-them"><a class="header" href="#build-micro-ros-tools-and-source-them">Build micro-ROS Tools and Source Them</a></h3>
<pre><code class="language-bash">colcon build
source install/local_setup.bash
</code></pre>
<h2 id="create-firmware-for-the-microblaze"><a class="header" href="#create-firmware-for-the-microblaze">Create Firmware for the Microblaze</a></h2>
<p>Now we need to create the micro-ROS libraries.
The following steps were taken from (there is no need to use the link):<br />
<a href="https://micro.ros.org/docs/tutorials/advanced/create_custom_static_library/">Creating Custom Static Library Instructions</a></p>
<h3 id="run-the-following-command-and-create-the-firmware-directory"><a class="header" href="#run-the-following-command-and-create-the-firmware-directory">Run the Following Command and Create the Firmware Directory</a></h3>
<pre><code class="language-bash">ros2 run micro_ros_setup create_firmware_ws.sh generate_lib
</code></pre>
<h3 id="create-colcon-and-toolchain-files"><a class="header" href="#create-colcon-and-toolchain-files">Create colcon and Toolchain Files</a></h3>
<pre><code class="language-bash">touch my_custom_toolchain.cmake
touch my_custom_colcon.meta
</code></pre>
<p>Copy and paste from the supplied files into the created files.<br />
<a href="files/uROS/my_custom_colcon.meta">my_custom_colcon.meta</a><br />
<a href="files/uROS/my_custom_toolchain.cmake">my_custom_toolchain.cmake</a></p>
<p>Inside the Cmake file, change the following lines according to the correct Xilinx version.</p>
<pre><code class="language-bash"># SET HERE THE PATH TO YOUR C99 AND C++ COMPILERS
set(CMAKE_C_COMPILER /tools/Xilinx/Vitis/2022.2/gnu/microblaze/lin/bin/mb-gcc)
set(CMAKE_CXX_COMPILER /tools/Xilinx/Vitis/2022.2/gnu/microblaze/lin/bin/mb-g++)
</code></pre>
<p>Inside the colcon file, you can change the properties of the micro-ros (such as number of nodes)</p>
<pre><code class="language-bash">        "rmw_microxrcedds": {
            "cmake-args": [
                "-DRMW_UXRCE_MAX_NODES=1",
                "-DRMW_UXRCE_MAX_PUBLISHERS=5",
                "-DRMW_UXRCE_MAX_SUBSCRIPTIONS=5",
                "-DRMW_UXRCE_MAX_SERVICES=1",
                "-DRMW_UXRCE_MAX_CLIENTS=1",
                "-DRMW_UXRCE_MAX_HISTORY=4",
                "-DRMW_UXRCE_TRANSPORT=custom"
            ]
        },
</code></pre>
<h3 id="create-firmware--create-the-build-directory-and-a-file"><a class="header" href="#create-firmware--create-the-build-directory-and-a-file">Create Firmware – Create the Build Directory and .a File</a></h3>
<pre><code class="language-bash">ros2 run micro_ros_setup build_firmware.sh $(pwd)/my_custom_toolchain.cmake $(pwd)/my_custom_colcon.meta
</code></pre>
<h3 id="current-problems"><a class="header" href="#current-problems">Current Problems</a></h3>
<p><strong>Directory Structure</strong>:<br />
In one of the updates of ROS, the directory structure of the files changed.<br />
From:</p>
<pre><code class="language-cpp">#include &lt;rcl/rcl.h&gt;
</code></pre>
<p>To:</p>
<pre><code class="language-cpp">#include &lt;rcl/rcl/rcl.h&gt;
</code></pre>
<p>The problem is that the <code>#include</code> lines inside the files are not compatible with the new version.<br />
The current solution is to build the project and then to add links to each subdirectory needed so the compiler will see these directories as written in the includes (for example – add link to the first <code>rcl</code> directory).<br />
Wanted solution – probably a CMake file problem.
Current Solution: during the build of the code inside vitis, we will create links for the sub files (explained the the vitis chapter)</p>
<!--stackedit_data:
eyJoaXN0b3J5IjpbLTQzMjk2OTYsLTEzMzgxODI4NTgsNzMwOT
k4MTE2XX0=
-->
<div style="break-before: page; page-break-before: always;"></div><h1 id="add-uart"><a class="header" href="#add-uart">Add UART</a></h1>
<h2 id="first-step--add-output-of-irq-from-zynq-to-microblaze"><a class="header" href="#first-step--add-output-of-irq-from-zynq-to-microblaze">First Step – Add output of IRQ from ZYNQ to MicroBlaze</a></h2>
<p>We want to connect PS_PL_irq_uart1 line from ZYNQ to MB xlconcat ip</p>
<ol>
<li>Double click on ZYNQ IP to open Re-customize IP window.</li>
<li>Add output to ZYNQ - Go to PS-PL Configuration.</li>
<li>In the window choose - General-&gt;Interruptd-&gt;PS to PL-&gt;UART-UART1 and set to 1
<img src="images/UART/UART_1.png" alt="UART1" /></li>
<li>Connect port to MicroBlaze change xlconcat  size to 2 and connect to ZYNQ PS_PL_irq_uart, Click Validate design</li>
</ol>
<h2 id="second-step--add-axi-connection-to-microblaze-not-sure-if-necessary"><a class="header" href="#second-step--add-axi-connection-to-microblaze-not-sure-if-necessary">Second Step – Add AXI Connection to MicroBlaze (not sure if necessary)</a></h2>
<ol>
<li>Add ports to ZYNQ:
<ul>
<li>Go to PS-PL Configuration.</li>
<li>In the window, choose Slave Interface -&gt; AXI HP -&gt; AXI LPD and set ‘v’.</li>
<li>Make sure AXI LPD Data Width is 12.<br />
<img src="images/UART/UART_2.png" alt="UART2" /></li>
</ul>
</li>
<li>Connect to bus:
<ul>
<li>Run connection automation.</li>
</ul>
</li>
</ol>
<p>There might be a good explanation here: <a href="https://support.xilinx.com/s/article/1175350?language=en_US">Xilinx Support</a></p>
<!--stackedit_data:
eyJoaXN0b3J5IjpbLTE2OTAxNDU0MjMsLTE4NDIwOTE0MTQsNz
MwOTk4MTE2XX0=
-->
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-to-create-ros-project-in-vitis"><a class="header" href="#how-to-create-ros-project-in-vitis">How to create ROS project in vitis</a></h1>
<h2 id="step-1-copy-ros-c-files-to-src-directory"><a class="header" href="#step-1-copy-ros-c-files-to-src-directory">Step 1: Copy ROS .c Files to src Directory</a></h2>
<ul>
<li>Copy necessary .c files (e.g., allocator) to the <code>src</code> directory.</li>
<li>These files contain functions for micro-ROS, and the main files to run the program.</li>
</ul>
<h3 id="files"><a class="header" href="#files">Files:</a></h3>
<p>All files needed to run uROS.<br />
<a href="files/Vitis/main.c">main.c</a><br />
<a href="files/Vitis/custom_memory_manager.c">custom_memory_manager.c</a><br />
<a href="files/Vitis/microros_allocator.c">microros_allocator.c</a><br />
<a href="files/Vitis/microros_time.c">microros_time.c</a><br />
<a href="files/Vitis/uart_transport.c">uart_transport.c</a></p>
<h2 id="step-2-create-a-link-for-the-micro-ros-directories"><a class="header" href="#step-2-create-a-link-for-the-micro-ros-directories">Step 2: Create a Link for the micro-ROS Directories</a></h2>
<ul>
<li>Go to the properties of the project.<br />
<img src="images/ROS_PRJ/PRJ_1.jpg" alt="PRJ1" /></li>
<li>Navigate to: <code>C/C++ Build -&gt; Settings -&gt; MicroBlaze gcc compiler -&gt; Directories</code>.<br />
<img src="images/ROS_PRJ/PRJ_2.jpg" alt="PRJ2" /></li>
<li>Click "Add" (top right corner of the screen).</li>
<li>Insert the link to the <code>microblaze_ws</code> include file: <code>/&lt;path&gt;/microros_ws/firmware/build/include</code>.</li>
</ul>
<h2 id="step-3-create-a-link-for-the-a-file"><a class="header" href="#step-3-create-a-link-for-the-a-file">Step 3: Create a Link for the .a File</a></h2>
<ul>
<li>Go to the properties of the project (same as before).</li>
<li>Navigate to: <code>C/C++ Build -&gt; Settings -&gt; MicroBlaze gcc linker -&gt; Libraries</code>.</li>
<li>There are two boxes there:
<ul>
<li>Under "Library search path," click "Add" (top right corner of the lower box).<br />
<img src="images/ROS_PRJ/PRJ_3.jpg" alt="PRJ3" /></li>
<li>Insert the path to the <code>.a</code> file (the folder of the <code>.a</code> file): <code>/&lt;path&gt;/microros_ws/firmware/build/</code>.</li>
<li>Under "Libraries (-l)," click "Add" (top right corner of the upper box) and add the flag <code>microros</code>.</li>
</ul>
</li>
</ul>
<h2 id="step-4-configure-uart-for-microblaze"><a class="header" href="#step-4-configure-uart-for-microblaze">Step 4: Configure UART for microblaze</a></h2>
<ul>
<li>Ensure the input to the microblaze is the UART:
<ul>
<li>Under the design wrapper/platform (green box), go to <code>platform.spr</code>.<br />
<img src="images/ROS_PRJ/PRJ_4.png" alt="PRJ4" /></li>
<li>Navigate to: <code>Board Support Package -&gt; Modify BSP Settings</code>.<br />
<img src="images/ROS_PRJ/PRJ_5.png" alt="PRJ5" /></li>
<li>Go to <code>Overview -&gt; Standalone</code> and change <code>stdin</code> and <code>stdout</code> to <code>psu_uart_1</code> (and click OK).<br />
<img src="images/ROS_PRJ/PRJ_6.png" alt="PRJ6" /></li>
</ul>
</li>
</ul>
<h2 id="step-5-address-problem-with-micro-ros-directories"><a class="header" href="#step-5-address-problem-with-micro-ros-directories">Step 5: Address Problem with micro-ROS Directories</a></h2>
<ul>
<li>Due to changes in the directory structure of micro-ROS, there might be problems building the code. Additional directories need to be included for the compiler.</li>
<li>Go to the properties of the project.</li>
<li>Navigate to: <code>C/C++ Build -&gt; Settings -&gt; MicroBlaze gcc compiler -&gt; Directories</code>.</li>
<li>Click "Add" (top right corner of the screen).
<img src="images/ROS_PRJ/PRJ_7.jpg" alt="PRJ7" /></li>
<li>Insert the link to the first directory in the tree for each missing file. For example: <code>/&lt;path&gt;/microros_ws/firmware/build/include/rcl</code>.
<ul>
<li>The file itself is at: <code>/&lt;path&gt;/microros_ws/firmware/build/include/rcl/rcl/rcl.h</code>.</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="gpio--interrupts"><a class="header" href="#gpio--interrupts">GPIO &amp; Interrupts</a></h1>
<p>We created for testing 2 AXI_GPIO objects: one for inputs and one for outputs. Then we enabled interrupts for the AXI_GPIO used for inputs and connected it to the interrupt controller.</p>
<h2 id="hardware-side"><a class="header" href="#hardware-side">Hardware Side</a></h2>
<h3 id="add-axi_gpio-block"><a class="header" href="#add-axi_gpio-block">Add AXI_GPIO Block</a></h3>
<ol>
<li>Set all inputs/all outputs for simple use.
<img src="images/GPIO/GPIO_1.png" alt="GPIO1" /></li>
<li>Use “Run Connection Automation” (it will add this part that we will remove later).
<img src="images/GPIO/GPIO_2.png" alt="GPIO2" /></li>
</ol>
<h3 id="connect-to-external-gpio-pins-and-etc"><a class="header" href="#connect-to-external-gpio-pins-and-etc">Connect to External GPIO (pins and etc.)</a></h3>
<ol>
<li>Press the ‘+’ near the word GPIO and then right-click on the line under and choose make external.
<img src="images/GPIO/GPIO_3.png" alt="GPIO3" /></li>
<li>Now we can delete the wire and pin connected to the GPIO name (in orange).
<img src="images/GPIO/GPIO_4.png" alt="GPIO4" /></li>
</ol>
<h3 id="define-the-physical-connection"><a class="header" href="#define-the-physical-connection">Define the Physical Connection</a></h3>
<ol>
<li>Add a source file:
<ul>
<li>Go to ‘Source’ -&gt; ‘Constraints’ and then right-click and choose ‘Add Sources’.<br />
<img src="images/GPIO/GPIO_5.png" alt="GPIO5" /></li>
<li>Choose ‘Add or create constraints’.<br />
<img src="images/GPIO/GPIO_6.png" alt="GPIO6" /></li>
<li>Then choose create file.<br />
<img src="images/GPIO/GPIO_7.png" alt="GPIO7" /></li>
<li>Click ‘ok’ and then ‘finish’.</li>
</ul>
</li>
<li>Now open the file and add the code to config the board.<br />
<img src="images/GPIO/GPIO_8.png" alt="GPIO8" /></li>
</ol>
<h3 id="how-to-connect-the-ports-from-the-xsa-to-gpio"><a class="header" href="#how-to-connect-the-ports-from-the-xsa-to-gpio">How to Connect the Ports from the XSA to GPIO</a></h3>
<ol>
<li>We will define 2 things for each port: their type (voltage) and actual connection (need to find the pin mapping of the board; D7 is an example):
<pre><code class="language-tcl">set_property IOSTANDARD LVCMOS18 [get_ports {pin_out[0]}]
set_property PACKAGE_PIN D7 [get_ports {pin_out[0]}]
</code></pre>
The command <code>[get_ports {pin_out[0]}]</code> returns the object of the <code>pin_out[0]</code> (the name we chose for the port).</li>
</ol>
<h3 id="connect-interrupts"><a class="header" href="#connect-interrupts">Connect Interrupts</a></h3>
<ol>
<li>Open the AXI_GPIO properties and choose “enable interrupts”.<br />
<img src="images/GPIO/GPIO_9.png" alt="GPIO9" /></li>
<li>In our design, the interrupt controller <code>intr</code> (interrupt request) is connected through the “Concat” object.<br />
<img src="images/GPIO/GPIO_10.png" alt="GPIO10" /></li>
<li>We will go to the Concat object and add a port. Then we will manually connect the irq pin from the AXI_GPIO to the open In pin.<br />
<img src="images/GPIO/GPIO_11.png" alt="GPIO11" /></li>
<li>Then press “Validate design” and you will see the added input to the interrupt controller.<br />
<img src="images/GPIO/GPIO_12.png" alt="GPIO12" /></li>
</ol>
<h2 id="software-side"><a class="header" href="#software-side">Software Side</a></h2>
<p>After we create a project with the AXI GPIO block we will have some new files we can include (we won’t be able to include these files if there is no AXI_GPIO IP in the XSA file).</p>
<h3 id="needed-includes"><a class="header" href="#needed-includes">Needed Includes</a></h3>
<pre><code class="language-c">/* GPIO includes */
#include "xil_io.h"
#include "xgpio.h"
</code></pre>
<h3 id="defines-of-the-axi-gpio-ips"><a class="header" href="#defines-of-the-axi-gpio-ips">Defines of the AXI GPIO IPs</a></h3>
<p>We had one IP for inputs and one for outputs. The LED defines are for choosing which pins to use. The channel is in case you enabled 2 channels in the Vivado for the AXI_GPIO object. We found the ID in “/&lt;project_name&gt;/export/&lt;project_name&gt;/sw/&lt;project_name&gt;/freertos10_xilinx_microblaze_0/bspinclude/include/xparameters.h”.</p>
<pre><code class="language-c">/* GPIO defines */
#define GPIO_DEVICE_ID_OUT      XPAR_GPIO_0_DEVICE_ID       // ID of the GPIO object
#define LED                     0x01
#define LED_CH                  1
#define LED_DEL                 10000000

#define GPIO_DEVICE_ID_IN       XPAR_GPIO_1_DEVICE_ID
</code></pre>
<h3 id="create-object-class-that-will-work-with-the-ip"><a class="header" href="#create-object-class-that-will-work-with-the-ip">Create Object (“class”) that will Work with the IP</a></h3>
<pre><code class="language-c">/* GPIO variables */
XGpio Gpio_out;
XGpio Gpio_in;
</code></pre>
<h3 id="initialize-and-perform-readwrite"><a class="header" href="#initialize-and-perform-readwrite">Initialize and Perform Read/Write</a></h3>
<pre><code class="language-c">// INIT GPIO OUT OBJECT
Status = XGpio_Initialize(&amp;Gpio_out, GPIO_DEVICE_ID_OUT);
if (Status != XST_SUCCESS) {
    xil_printf("GPIO OUT INIT fail!");
}
// Write to GPIO object
XGpio_DiscreteWrite(&amp;Gpio_out, LED_CH, BUTTON_VOLTAGE); // set GPIO to OFF maybe set to 0x01 for as voltage src

// INIT GPIO IN OBJECT
Status = XGpio_Initialize(&amp;Gpio_in, GPIO_DEVICE_ID_IN);
if (Status != XST_SUCCESS) {
    xil_printf("GPIO IN INIT fail!");
}
// Read from GPIO object
button_red_1 = XGpio_DiscreteRead(&amp;Gpio_in, BUTTON_CH);
</code></pre>
<h3 id="work-with-interrupts"><a class="header" href="#work-with-interrupts">Work with Interrupts</a></h3>
<p>Because we work with an operating system, we need to create a function that will work as ISR and then let the OS do the rest of the work. In general, you need to tell the OS which function will be used as ISR.</p>
<p>Good explanation: <a href="https://www.freertos.org/RTOS-Xilinx-Microblaze-KC705.html#implementing_an_ISR">FreeRTOS Xilinx MicroBlaze</a></p>
<p>In general:</p>
<ol>
<li>Get the ISR id. You will have the define <code>XPAR_INTC_0_GPIO_1_VEC_ID</code> under “/&lt;project_name&gt;/export/&lt;project_name&gt;/sw/&lt;project_name&gt;/freertos10_xilinx_microblaze_0/bspinclude/include/xparameters.h”.</li>
<li>Get the interrupt controller id. You will have the define <code>XPAR_INTC_0_DEVICE_ID</code> under “/&lt;project_name&gt;/export/&lt;project_name&gt;/sw/&lt;project_name&gt;/freertos10_xilinx_microblaze_0/bspinclude/include/xparameters.h”.</li>
<li>Declare the function that will be used as ISR.</li>
<li>Use <code>xPortInstallInterruptHandler</code> to set the function as interrupt handler.</li>
<li>Enable interrupt with <code>vPortEnableInterrupt</code>.</li>
</ol>
<pre><code class="language-c">/* Interrupts */
#define INTC_DEVICE_ID          XPAR_INTC_0_DEVICE_ID
#define INTC_DEVICE_INT_ID      XPAR_INTC_0_GPIO_1_VEC_ID
Status = xPortInstallInterruptHandler(INTC_DEVICE_INT_ID, myInterruptHandler, NULL);
vPortEnableInterrupt(INTC_DEVICE_INT_ID);
</code></pre>
<h3 id="current-problem"><a class="header" href="#current-problem">Current Problem</a></h3>
<p>These 2 functions are defined in the <code>portmacro.h</code> file with <code>uint8_t</code> as the first argument. In the <code>port.c</code> files, there is a define <code>XPAR_XILTIMER_ENABLED</code> that sets the first argument as <code>uint16_t</code> and that creates the error “undefined reference to <code>xPortInstallInterruptHandler</code>”.</p>
<p>In order to let the function compile, we need to set this var to 0.</p>
<p>Right now the interrupts don’t work.</p>
<!--stackedit_data:
eyJoaXN0b3J5IjpbLTgzODY1MDA1NCw3MzA5OTgxMTZdfQ==
-->
<div style="break-before: page; page-break-before: always;"></div><h1 id="create-new-vitis-project"><a class="header" href="#create-new-vitis-project">Create New Vitis Project</a></h1>
<h2 id="open-vitis-project-with-freertos"><a class="header" href="#open-vitis-project-with-freertos">Open Vitis Project with FreeRtos</a></h2>
<p>In this tutorial, we will explain step-by-step how to create a basic FreeRTOS application.</p>
<h3 id="steps"><a class="header" href="#steps">Steps:</a></h3>
<ol>
<li>Open Vitis and create a new application project.<br />
<img src="images/NEW_VITIS_PROJ/NEW_VITIS_1.png" alt="N_VITIS_PROG1" /></li>
<li>Click next and choose the tab “Create a new platform from hardware (XSA).<br />
<img src="images/NEW_VITIS_PROJ/NEW_VITIS_2.png" alt="N_VITIS_PROG2" /></li>
<li>Click browse and choose the XSA file (this file contains the Hardware to burn into the FPGA) then click next.
<ul>
<li>Link to <a href="files/NEW_VITIS_PROJ/***.xsa">XSA FIle</a>
<img src="images/NEW_VITIS_PROJ/NEW_VITIS_3.png" alt="N_VITIS_PROG3" /></li>
</ul>
</li>
<li>Now choose create a new system project, and choose from the target processor the <code>microblaze_0</code>.<br />
<img src="images/NEW_VITIS_PROJ/NEW_VITIS_4.png" alt="N_VITIS_PROG4" /></li>
<li>Create a new domain using <code>freertos10_xilinx</code> operating system.<br />
<img src="images/NEW_VITIS_PROJ/NEW_VITIS_5.png" alt="N_VITIS_PROG5" /></li>
<li>Choose a code template (You can choose FreeRTOS Hello World to test everything works as needed).<br />
<img src="images/NEW_VITIS_PROJ/NEW_VITIS_6.png" alt="N_VITIS_PROG6" /></li>
<li>Click finish.</li>
<li>Go to the terminal of the MicroBlaze and the result should be:
<img src="images/NEW_VITIS_PROJ/NEW_VITIS_8.png" alt="N_VITIS_PROG8" /></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="code-over-view"><a class="header" href="#code-over-view">Code Over View</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="running-everthing"><a class="header" href="#running-everthing">Running everthing</a></h1>
<p>Steps to fallow in ORDER!:</p>
<ul>
<li><a href="running.html#open-vitis">Open Vitis</a></li>
<li><a href="running.html#uros">uROS</a></li>
<li><a href="running.html#run-fpga">Run FPGA</a></li>
<li><a href="running.html#tools">Tools</a></li>
</ul>
<h2 id="open-vitis"><a class="header" href="#open-vitis">Open Vitis</a></h2>
<ol>
<li>Open NEW terminal:</li>
<li>write <code>source /tools/Xilinx/Vitis/2022.2/settings64.sh</code></li>
<li>write <code>vitis</code> in terminal</li>
</ol>
<h2 id="uros"><a class="header" href="#uros">uROS</a></h2>
<ol>
<li>Enter workspace:</li>
</ol>
<pre><code class="language-bash">cd microros_ws/
</code></pre>
<ol start="2">
<li>Make sure xilinx board USB is connected and visable:</li>
</ol>
<pre><code class="language-bash">ll /sys/class/tty/ttyUSB*
</code></pre>
<h3 id="open-two-terminals"><a class="header" href="#open-two-terminals">Open two terminals:</a></h3>
<h4 id="terminal-1"><a class="header" href="#terminal-1">Terminal 1:</a></h4>
<ol start="3">
<li>Soruce uROS:</li>
</ol>
<pre><code class="language-bash">source install/local_setup.bash
</code></pre>
<ol start="4">
<li>Allow non-root/ros2 access to USB (Please re-run with superuser privileges):</li>
</ol>
<pre><code class="language-bash">sudo chmod 666 /dev/ttyUSB*
</code></pre>
<ol start="5">
<li>Running the micro-ROS app:</li>
</ol>
<pre><code class="language-bash">ros2 run micro_ros_agent micro_ros_agent serial --dev /dev/serial/by-id/usb-Xilinx_JTAG+Serial_1234-oj1-if01-port0 -v 6
</code></pre>
<h2 id="run-fpga"><a class="header" href="#run-fpga">Run FPGA</a></h2>
<ol>
<li>Build Project :hammer:</li>
<li>Debug As -&gt; Launch Hardware</li>
</ol>
<h2 id="tools"><a class="header" href="#tools">Tools</a></h2>
<ol>
<li>Open new terminal and soruces uROS:</li>
</ol>
<pre><code class="language-bash">source install/local_setup.bash
</code></pre>
<ol start="2">
<li>Subscribe to micro-ROS ping topic</li>
</ol>
<pre><code class="language-bash">ros2 topic echo /vitis_publisher
</code></pre>
<p>or</p>
<pre><code class="language-bash">rqt
</code></pre>
<p>    Inside the RQT window: Plugin -&gt; Visulatasions -&gt; Image View</p>
<h2 id="usfull-commends"><a class="header" href="#usfull-commends">Usfull Commends</a></h2>
<p>Find all topics on grath:</p>
<pre><code class="language-bash">ros2 topic list
</code></pre>
<p>Print data foing through a topic:</p>
<pre><code class="language-bash">ros2 topic echo /topic
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
